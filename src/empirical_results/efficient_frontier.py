# standard library imports

# third party imports
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

# local imports
from src.models import MADModel, MarkowitzModel
from src.utils import generate_random_weights, simulate_returns


class EfficientFrontier:
    """Class for plotting the efficient frontier of the portfolio"""

    def __init__(self) -> None:
        """
        Initialize the EfficientFrontier class
        """

        self.n_portfolios = 10000

    def draw_efficient_frontier(
        self,
        returns_data: pd.DataFrame,
        model: str,
    ) -> None:
        """
        Plot the efficient frontier of the portfolio

        Parameters:
            returns_data (DataFrame): DataFrame containing the returns data
            min_returns (List[float]): List of minimum returns to plot
            model (str): Model to use for the efficient frontier
        """

        assert model in ["markowitz", "mad"]

        risk_label = (
            "Standard Deviation" if model == "markowitz" else "Mean Absolute Deviation"
        )

        mean_returns = returns_data.mean()
        cov_matrix = returns_data.cov()

        # Generate random portfolios
        np.random.seed(431)
        random_expected_returns = []
        random_risks = []
        for _ in range(self.n_portfolios):
            random_weights = generate_random_weights(len(mean_returns))
            random_expected_returns.append(random_weights @ mean_returns)

            if model == "markowitz":
                random_risks.append(
                    np.sqrt(random_weights.T @ cov_matrix @ random_weights)
                )
            else:
                random_risks.append(
                    np.mean(np.abs((returns_data - mean_returns) @ random_weights))
                )

        ef_x = []
        ef_y = []
        min_returns = np.linspace(
            random_expected_returns[np.argmin(random_risks)],
            np.max(random_expected_returns),
            50,
        )
        for min_return in min_returns:
            if model == "markowitz":
                mw_model = MarkowitzModel(returns_data, min_return, "regular")
                _, expected_return, risk = mw_model()
                ef_x.append(expected_return)
                ef_y.append(risk)
            else:
                mad_model = MADModel(returns_data, min_return)
                _, expected_return, risk = mad_model()
                ef_x.append(expected_return)
                ef_y.append(risk)

        plt.scatter(
            random_expected_returns, random_risks, marker=".", s=1, color="blue"
        )
        plt.plot(
            ef_x,
            ef_y,
            color="orange",
            linestyle="solid",
            linewidth=3,
            label="Efficient Frontier",
        )
        plt.xlabel("Expected Return")
        plt.ylabel(risk_label)
        plt.legend(loc="upper left")
        plt.show()

    def compare_efficient_frontiers(self, returns_data: pd.DataFrame) -> None:
        """
        Plot the efficient frontiers of the optimal portfolios generated by
        the Markowitz and MAD models, using standard deviation as the common
        measure of risk

        Parameters:
            returns_data (DataFrame): DataFrame containing the returns data
        """

        mean_returns = returns_data.mean()
        cov_matrix = returns_data.cov()

        # Generate random portfolios
        random_expected_returns = []
        random_risks = []
        for _ in range(self.n_portfolios):
            random_weights = generate_random_weights(len(mean_returns))
            random_expected_returns.append(random_weights @ mean_returns)
            random_risks.append(np.sqrt(random_weights.T @ cov_matrix @ random_weights))

        ef_x_mw = []
        ef_y_mw = []
        ef_x_mad = []
        ef_y_mad = []
        min_returns = np.linspace(
            random_expected_returns[np.argmin(random_risks)],
            np.max(random_expected_returns),
            100,
        )
        for min_return in min_returns:
            mw_model = MarkowitzModel(returns_data, min_return, "regular")
            _, expected_return_mw, risk_mw = mw_model()
            ef_x_mw.append(expected_return_mw)
            ef_y_mw.append(risk_mw)

            mad_model = MADModel(returns_data, min_return)
            weights_mad, expected_return_mad, _ = mad_model()
            risk_mad = np.sqrt(weights_mad.T @ cov_matrix @ weights_mad)
            ef_x_mad.append(expected_return_mad)
            ef_y_mad.append(risk_mad)

        plt.figure(figsize=(6, 8))
        # plt.scatter(
        #     random_expected_returns, random_risks, marker=".", s=1, color="blue"
        # )
        plt.plot(
            ef_x_mw,
            ef_y_mw,
            color="red",
            linestyle="solid",
            linewidth=3,
            label="Markowitz",
        )
        plt.plot(
            ef_x_mad,
            ef_y_mad,
            color="green",
            linestyle="solid",
            linewidth=3,
            label="MAD",
        )
        plt.xlabel("Expected Return")
        plt.ylabel("Standard Deviation")
        plt.legend(loc="upper left")
        plt.show()
